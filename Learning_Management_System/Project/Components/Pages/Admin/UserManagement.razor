@page "/usermanagement"
@inject IDbContextFactory<D424DataContext> D424DataContextFactory
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager nav

<PageTitle>Accounts | SWCSC Portal</PageTitle>

<MudDataGrid T="User" Items="@Global.AllUsers" EditMode="DataGridEditMode.Form" Filterable="true" StartedEditingItem="@StartedEditingItem" CanceledEditingItem="@CanceledEditingItem" CommittedItemChanges="@UpdateUser" EditTrigger="@DataGridEditTrigger.OnRowClick"
             Bordered="true" ReadOnly="false" Dense="true" QuickFilter="Search" Class="mt-6" RowsPerPage="50">
  <ToolBarContent>
    <MudButton Class="mt-8 mb-4 mr-4" Variant="Variant.Filled" Color="Color.Secondary" OnClick="OnAddUserClicked">Add User</MudButton>
    <MudTooltip Text="Refresh List">
      <MudIconButton Class="mt-8 mb-4" Color="Color.Tertiary" Icon="@Icons.Material.Filled.Refresh" Variant="Variant.Filled" OnClick="RefreshAllUsers"></MudIconButton>
    </MudTooltip>
    <MudSpacer />
    <MudSpacer />
    <MudTextField @bind-Value="searchInput" Style="@($"background:{Colors.Gray.Lighten5}")" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-8 mb-4" Immediate="true"></MudTextField>
  </ToolBarContent>
  <Columns>
    <PropertyColumn Property="x => x.Id" Editable="false"/>
    <PropertyColumn Property="x => x.FirstName" Title="First Name" />
    <PropertyColumn Property="x => x.LastName" Title="Last Name" />
    <PropertyColumn Property="x => x.Role" >
      <EditTemplate>
        <MudSelect T="string" @bind-Value="selectedUser.Role" Variant="Variant.Outlined" Label="Role*" Margin="Margin.Dense" Class="mt-4 align-self-stretch">
          <MudSelectItem T="string" Value="@("Student")">Student</MudSelectItem>
          <MudSelectItem T="string" Value="@("Teacher")">Teacher</MudSelectItem>
          <MudSelectItem T="string" Value="@("Admin")">Admin</MudSelectItem>
        </MudSelect>
      </EditTemplate>
    </PropertyColumn>
    <PropertyColumn Property="x => x.GradeLevel" Title="Grade Level">
      <EditTemplate>
        <MudSelect T="int" @bind-Value="selectedUser.GradeLevel" Variant="Variant.Outlined" Label="Grade Level*" Margin="Margin.Dense" Class="mt-4 align-self-stretch">
          <MudSelectItem T="int" Value="@(0)">0</MudSelectItem>
          <MudSelectItem T="int" Value="@(1)">1</MudSelectItem>
          <MudSelectItem T="int" Value="@(2)">2</MudSelectItem>
          <MudSelectItem T="int" Value="@(3)">3</MudSelectItem>
          <MudSelectItem T="int" Value="@(4)">4</MudSelectItem>
          <MudSelectItem T="int" Value="@(5)">5</MudSelectItem>
          <MudSelectItem T="int" Value="@(6)">6</MudSelectItem>
          <MudSelectItem T="int" Value="@(7)">7</MudSelectItem>
          <MudSelectItem T="int" Value="@(8)">8</MudSelectItem>
          <MudSelectItem T="int" Value="@(9)">9</MudSelectItem>
          <MudSelectItem T="int" Value="@(10)">10</MudSelectItem>
          <MudSelectItem T="int" Value="@(11)">11</MudSelectItem>
          <MudSelectItem T="int" Value="@(12)">12</MudSelectItem>
        </MudSelect>
      </EditTemplate>
    </PropertyColumn>
    <PropertyColumn Property="x => x.Username" />
    <PropertyColumn Property="x => x.Password" Required ="true">
      <CellTemplate>
        ****
      </CellTemplate>
      <EditTemplate>
        <MudTextField @bind-Value="selectedUser.Password" Label="Password" Variant="Variant.Outlined" Required="true" Margin="Margin.Dense" Class="mt-4" Validation="@(new Func<string, IEnumerable<string>>(PasswordValidation))"></MudTextField>
      </EditTemplate>
    </PropertyColumn>
    <PropertyColumn Property="x => x.FailedAttempts" Title="Failed Attempts" />
    <PropertyColumn Property="x => x.Locked" Title="Locked?">
      <EditTemplate>
        <MudSelect T="string" @bind-Value="selectedUser.Locked" Variant="Variant.Outlined" Label="Locked?*" Margin="Margin.Dense" Class="mt-4">
          <MudSelectItem T="string" Value="@("Yes")">Yes</MudSelectItem>
          <MudSelectItem T="string" Value="@("No")">No</MudSelectItem>
        </MudSelect>
      </EditTemplate>
    </PropertyColumn>
    <PropertyColumn Property="x => x.Created"/>
    <PropertyColumn Property="x => x.LastUpdate" Title="Last Update"/>
    <PropertyColumn Property="x => x.LastUpdate" Title="" Filterable="false"> <!-- Works around cell misalignment using template column -->
      <CellTemplate>
        <MudTooltip Text="Delete user">
          <MudIconButton Variant="Variant.Filled" Color="Color.Error" Size="@Size.Medium" Icon="@Icons.Material.Outlined.Delete" OnClick="() => DeleteUser(context.Item)" />
        </MudTooltip>
      </CellTemplate>
    </PropertyColumn>
  </Columns>
  <PagerContent>
    <MudDataGridPager/>
  </PagerContent>
</MudDataGrid>
